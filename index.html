<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>แบบฟอร์มขอดูกล้องวงจรปิด</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;700&display=swap');
    :root { font-family: 'Noto Sans Thai', sans-serif; }
    .container { max-width: 640px; }
  </style>
</head>

<body class="bg-gray-100 min-h-screen p-4 flex items-center justify-center">

  <div class="container bg-white p-6 md:p-10 rounded-xl shadow-lg w-full">

    <div class="flex justify-center mb-6">
      <img src="https://triampreng.ac.th/images/sampledata/parks/bb/images.png"
           alt="School Logo"
           class="h-40 max-h-44 w-auto object-contain"
           onerror="this.src='https://via.placeholder.com/150x80?text=Logo';">
    </div>

    <h1 class="text-3xl font-bold text-center text-blue-600">
      แบบฟอร์มขอดูกล้องวงจรปิด
    </h1>
    <h3 class="text-2xl font-bold text-center text-blue-600 mb-6 border-b pb-3">
      โรงเรียนเบญจมราชรังสฤษฎิ์ ๒
    </h3>

    <p class="text-center text-sm text-gray-500 mb-8">
      สามารถขอดูย้อนหลังได้ไม่เกิน 7 วันนับจากวันที่เกิดเหตุ
    </p>

    <form id="cctvRequestForm" class="space-y-6">

      <!-- วันที่ต้องการดู -->
      <div>
        <label for="requestDate" class="block text-sm font-medium text-gray-700">
          วันที่ต้องการดู <span class="text-red-500">*</span>
        </label>
        <input type="date" id="requestDate" name="requestDate" required
               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
      </div>

      <!-- ช่วงเวลา -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label for="startTime" class="block text-sm font-medium text-gray-700">
            ช่วงเวลาเริ่มต้น <span class="text-red-500">*</span>
          </label>
          <input type="time" id="startTime" name="startTime" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
        </div>
        <div>
          <label for="endTime" class="block text-sm font-medium text-gray-700">
            ช่วงเวลาสิ้นสุด <span class="text-red-500">*</span>
          </label>
          <input type="time" id="endTime" name="endTime" required
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
        </div>
      </div>

      <!-- ตำแหน่งกล้อง -->
      <div>
        <label for="cameraLocation" class="block text-sm font-medium text-gray-700">
          ตำแหน่งกล้อง/บริเวณของกล้อง <span class="text-red-500">*</span>
        </label>
        <input type="text" id="cameraLocation" name="cameraLocation" required
               placeholder="เช่น อาคาร 1 ชั้น 1 ทางเข้า ห้อง 112"
               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
      </div>

      <!-- เหตุผล -->
      <div>
        <label for="reason" class="block text-sm font-medium text-gray-700">
          เหตุผลในการขอดู <span class="text-red-500">*</span>
        </label>
        <textarea id="reason" name="reason" rows="3" required
                  placeholder="ระบุเหตุการณ์โดยละเอียด เช่น ทรัพย์สินสูญหายเมื่อ..., ลักษณะของทรัพย์สิน, ลักษณะผู้ต้องสงสัย ฯลฯ"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
      </div>

      <!-- ข้อมูลผู้ขอ -->
      <div class="space-y-4 pt-3 border-t border-gray-200">
        <h2 class="text-lg font-semibold text-gray-800">ข้อมูลผู้ขอ</h2>

        <div>
          <label for="requesterName" class="block text-sm font-medium text-gray-700">
            ชื่อ-นามสกุลผู้ขอ <span class="text-red-500">*</span>
          </label>
          <input type="text" id="requesterName" name="requesterName" required
                 placeholder="ชื่อ-นามสกุล"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
        </div>

        <div>
          <label for="contactPhone" class="block text-sm font-medium text-gray-700">
            เบอร์โทรศัพท์ติดต่อ <span class="text-red-500">*</span>
          </label>
          <input type="tel" id="contactPhone" name="contactPhone" required
                 placeholder="08XXXXXXXX"
                 pattern="[0-9]{10}" title="กรุณากรอกเบอร์โทรศัพท์ 10 หลัก"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
        </div>

        <div>
          <label for="contactEmail" class="block text-sm font-medium text-gray-700">
            อีเมลติดต่อกลับ <span class="text-red-500">*</span>
          </label>
          <input type="email" id="contactEmail" name="contactEmail" required
                 placeholder="email@example.com"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
        </div>

        <div>
          <label for="requesterClass" class="block text-sm font-medium text-gray-700">
            ชั้น/ระดับหรือหน่วยงาน <span class="text-red-500">*</span>
          </label>
          <input type="text" id="requesterClass" name="requesterClass" required
                 placeholder="เช่น ม.5/2, งานปกครอง"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            ประเภทผู้ขอ <span class="text-red-500">*</span>
          </label>
          <div class="flex space-x-6">
            <label class="inline-flex items-center">
              <input type="radio" name="userType" value="ครู/บุคลากร" required>
              <span class="ml-2 text-gray-700">ครู/บุคลากร</span>
            </label>
            <label class="inline-flex items-center">
              <input type="radio" name="userType" value="นักเรียน" required>
              <span class="ml-2 text-gray-700">นักเรียน</span>
            </label>
          </div>
        </div>
      </div>

      <!-- ปุ่มส่ง -->
      <div class="pt-4">
        <button type="submit" id="submitButton"
                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          บันทึกคำขอ
        </button>
      </div>
    </form>
  </div>

  <script>
    const form = document.getElementById('cctvRequestForm');

    function showLoading() {
      Swal.fire({
        title: 'กำลังบันทึกข้อมูล...',
        text: 'กรุณารอสักครู่',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });
    }

    function showSuccess(message) {
      Swal.fire({
        icon: 'success',
        title: 'สำเร็จ!',
        text: message || 'บันทึกข้อมูลคำขอเรียบร้อยแล้ว',
        confirmButtonText: 'ตกลง'
      }).then(() => {
        form.reset();
      });
    }

    function showError(message) {
      Swal.fire({
        icon: 'error',
        title: 'เกิดข้อผิดพลาด!',
        text: message || 'ไม่สามารถบันทึกข้อมูลได้ กรุณาลองใหม่อีกครั้ง',
        confirmButtonText: 'ตกลง'
      });
    }

    form.addEventListener('submit', function (event) {
      event.preventDefault();

      // รวบรวมข้อมูลจากฟอร์ม
      const formData = {
        requestDate: document.getElementById('requestDate').value,
        startTime: document.getElementById('startTime').value,
        endTime: document.getElementById('endTime').value,
        cameraLocation: document.getElementById('cameraLocation').value,
        reason: document.getElementById('reason').value,
        requesterName: document.getElementById('requesterName').value,
        contactPhone: document.getElementById('contactPhone').value,
        contactEmail: document.getElementById('contactEmail').value,
        requesterClass: document.getElementById('requesterClass').value,
        userType: document.querySelector("input[name='userType']:checked")?.value
      };

      if (!formData.userType) {
        showError('กรุณาเลือกประเภทผู้ขอ');
        return;
      }

      showLoading();

      // เรียกฟังก์ชันใน Code.gs ผ่าน google.script.run
      google.script.run
        .withSuccessHandler(function (res) {
          Swal.close();
          if (res && res.success) {
            showSuccess(res.message);
          } else {
            showError(res && res.error ? res.error : 'ไม่สามารถบันทึกข้อมูลได้');
          }
        })
        .withFailureHandler(function (err) {
          Swal.close();
          console.error('Apps Script error:', err);
          showError('เกิดข้อผิดพลาดจากระบบ: ' + (err.message || err));
        })
        .processCCTVRequest(formData);
    });
  </script>
</body>
</html>
